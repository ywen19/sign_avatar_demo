<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Sign Avatar Viewer</title>
  <style>
    html, body {
      margin: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      background: #000;
    }
  </style>
</head>
<body>

<!-- three.js 非模块版 -->
<script src="three.min.js"></script>
<!-- GLTFLoader 非模块版 -->
<script src="GLTFLoader.js"></script>

<script>
  console.log("Page loaded. href =", window.location.href);

  if (typeof THREE === "undefined") {
    console.error("THREE is undefined. three.min.js may not be loaded correctly.");
  } else {
    console.log("THREE version:", THREE.REVISION);
  }
  if (!THREE.GLTFLoader) {
    console.error("THREE.GLTFLoader is undefined. Check GLTFLoader.js.");
  } else {
    console.log("GLTFLoader detected.");
  }

  let scene, camera, renderer, avatar;

  init();
  loadModel();
  animate();

  function init() {
    scene = new THREE.Scene();
    scene.background = new THREE.Color(0x202020);

    camera = new THREE.PerspectiveCamera(
      45,
      window.innerWidth / window.innerHeight,
      0.1,
      1000
    );
    camera.position.set(0, 1.6, 3); // 初始给个大致位置

    renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(window.devicePixelRatio);
    renderer.outputEncoding = THREE.sRGBEncoding;
    document.body.appendChild(renderer.domElement);

    // 灯光：环境 + 方向光
    const hemi = new THREE.HemisphereLight(0xffffff, 0x444444, 1.2);
    scene.add(hemi);

    const dirLight = new THREE.DirectionalLight(0xffffff, 2);
    dirLight.position.set(5, 10, 5);
    scene.add(dirLight);

    window.addEventListener("resize", onWindowResize);
  }

  function loadModel() {
    const modelUrl = new URL("model.glb", window.location.href).href;
    console.log("Trying to load model from:", modelUrl);

    const loader = new THREE.GLTFLoader();

    loader.load(
      modelUrl,
      function (gltf) {
        avatar = gltf.scene;

        // 1) 放大模型到合适大小（你的 glb 很小）
        avatar.scale.set(100, 100, 100);

        // 先加入场景，便于计算包围盒
        scene.add(avatar);

        // 2) 让模型中心移到世界原点附近
        const bbox = new THREE.Box3().setFromObject(avatar);
        const size = new THREE.Vector3();
        const center = new THREE.Vector3();
        bbox.getSize(size);
        bbox.getCenter(center);

        console.log("Model bbox size:", size.x, size.y, size.z);
        console.log("Model bbox center:", center.x, center.y, center.z);

        // 把模型中心平移到 (0,0,0) 附近
        avatar.position.sub(center);

        // 3) 固定一个 camera 机位 + 观察点（显示整个人物）
        const targetY = 8.0;        // 角色身体中上部高度
        const distance = 23.0;       // 离角色的距离，越大越远

        camera.position.set(0, targetY, distance);
        camera.lookAt(0, targetY, 0);

        console.log("Camera set to:", camera.position.x, camera.position.y, camera.position.z);
        console.log("GLB loaded successfully.");
      },
      function (xhr) {
        if (xhr && xhr.total) {
          const percent = (xhr.loaded / xhr.total * 100).toFixed(2);
          console.log("Loading model... " + percent + "%");
        } else {
          console.log("Loading model... (no total size)");
        }
      },
      function (err) {
        console.error("GLB load failed:", err);
        alert("GLB load failed. See Python console for details.");
      }
    );
  }

  function animate() {
    requestAnimationFrame(animate);

    // if (avatar) {
      // 轻微旋转，方便展示
      // avatar.rotation.y += 0.003;
    // }

    renderer.render(scene, camera);
  }

  function onWindowResize() {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
  }
</script>

</body>
</html>
